<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
       /* General Styling */
body {
    font-family: 'Roboto', Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f9;
    color: #333;
}

h1 {
    text-align: center;
    margin: 20px 0;
    font-size: 2.5rem;
    color: #444;
}

.container {
    width: 90%;
    margin: auto;
    padding: 20px;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}

/* Navigation Bar */
.nav {
    display: flex;
    justify-content: space-around;
    background-color: #0056b3;
    padding: 15px 10px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.nav a {
    color: white;
    font-weight: bold;
    text-decoration: none;
    padding: 12px 20px;
    border-radius: 5px;
    transition: background-color 0.3s, color 0.3s;
}

.nav a:hover {
    background-color: #003d80;
    color: #fff;
}

/* Section Styling */
.section {
    display: none;
    margin: 20px 0;
    padding: 20px;
    background-color: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.section h2 {
    font-size: 1.8rem;
    color: #0056b3;
    margin-bottom: 20px;
}

/* Buttons */
button {
    background-color: #0056b3;
    color: white;
    font-weight: bold;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #003d80;
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    text-align: left;
    padding: 10px;
    border: 1px solid #ddd;
    font-size: 0.9rem;
}

th {
    background-color: #0056b3;
    color: white;
}

tr:nth-child(even) {
    background-color: #f9f9f9;
}

tr:hover {
    background-color: #f1f1f1;
}

/* Forms */
form label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
    color: #444;
}

form input, form select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 1rem;
}

/* Alerts and Responses */
#vehicleResponse, #driverResponse {
    margin-top: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #e9f6ff;
    color: #0056b3;
    font-size: 0.9rem;
}

.dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown button {
            background-color: #0056b3;
            color: white;
            font-weight: bold;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

        .dropdown button:hover {
            background-color: #003d80;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            z-index: 1;
            width: 100%;
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #ddd;
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

/* Mobile Responsiveness */
@media screen and (max-width: 768px) {
    .nav {
        flex-direction: column;
        align-items: center;
    }

    .nav a {
        margin-bottom: 10px;
        width: 100%;
        text-align: center;
    }

    button {
        width: 100%;
    }

    table {
        font-size: 0.8rem;
    }

    form input, form select {
        font-size: 0.9rem;
    }
}

    </style>
</head>
<body>
    <h1>Admin Dashboard</h1>
    
    <!-- Navigation Bar -->
    <div class="dropdown">
        <button>Menu</button>
        <div class="dropdown-content">
            <a href="#" onclick="toggleSection('wasteTracking')">Waste Production Tracking</a>
            <a href="#" onclick="toggleSection('collectionManagement')">Waste Collection Management</a>
            <a href="#" onclick="toggleSection('userManagement')">User Management</a>
            <a href="#" onclick="toggleSection('vehicleManagement')">Vehicle Management</a>
            <a href="#" onclick="toggleSection('complaints')">Complaint Reviewing</a>
            <a href="#" onclick="toggleSection('reporting')">Reporting & Analytics</a>
            <a href="/logout">Logout</a>
        </div>
    </div>
    <div class="container">

        <div class="main-content" id="mainContent"></div>
            <h2>Welcome to Admin Waste Management Dashboard</h2>
            <p>This comprehensive platform helps you manage and monitor waste management operations effectively.</p>
            <p>Key features include tracking waste production, managing waste collection, overseeing user activities, monitoring vehicles, reviewing complaints, and generating detailed reports.</p>
            <p>Select an option from the menu to get started with your administrative tasks.</p>
        </div>
        <!-- Vehicle Management Section -->
        <div class="section" id="vehicleManagement" style="display: none;">
            <h2>Vehicle Management</h2>
            <!-- Sub-navigation for Vehicle Management -->
            <div class="sub-nav">
                <button onclick="toggleVehicleList()">View Vehicles</button>
            </div>

            <!-- Vehicle List Section -->
            <div id="vehicleList" style="display: block;">
                <h3>List of Vehicles</h3>
                <form id="vehicleForm">
                    <label for="vehicle_id">Vehicle ID (for update):</label>
                    <input type="number" id="vehicle_id" name="vehicle_id" hidden>
                    <br>
                    <label for="driver_name">Driver Name:</label>
                    <input type="text" id="driver_name" name="driver_name" required>
                    <br>
                    <label for="driver_phone">Driver Phone:</label>
                    <input type="text" id="driver_phone" name="driver_phone" required>
                    <br>
                    <label for="area_id">Area ID:</label>
                    <input type="number" id="area_id" name="area_id" required>
                    <br>
                    <button type="submit">Add/Update Vehicle</button>
                </form>
                <div id="vehicleResponse"></div>
                <table>
                    <thead>
                        <tr>
                            <th>Vehicle ID</th>
                            <th>Driver Name</th>
                            <th>Driver Phone</th>
                            <th>Area ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vehicleManagementBody">
                        <!-- Vehicle data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Complaint Reviewing Section -->
        <div class="section" id="complaints" style="display: none;">
            <h2>Complaint Reviewing</h2>
            <table>
                <thead>
                    <tr>
                        <th>Complaint ID</th>
                        <th>User Id </th>
                        <th>Message</th>
                        <th>Image</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Resolution Details</th>
                    </tr>
                </thead>
                <tbody id="complaintTableBody">
                    <!-- Complaint data will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Waste Production Tracking Section -->
        <div class="section" id="wasteTracking" style="display: none;">
            <h2>Waste Production Tracking</h2>
            <p>Total Bio Waste: <span id="totalBioWaste">0</span> kg</p>
            <p>Total Non-Bio Waste: <span id="totalNonBioWaste">0</span> kg</p>
            <p>Total Waste Produced Today: <span id="totalWasteToday">0</span> kg</p>
            <h3>User-Specific Data</h3>
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Total Waste</th>
                    </tr>
                </thead>
                <tbody id="userWasteDataBody">
                    <!-- User-specific waste data will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Waste Collection Management Section -->
        <div class="section" id="collectionManagement" style="display: none;">
            <h2>Waste Collection Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>Area</th>
                        <th>Collection Schedule</th>
                        <th>Vehicle Assignment</th>
                        <th>Driver Details</th>
                    </tr>
                </thead>
                <tbody id="collectionManagementBody">
                    <!-- Collection management data will be populated here dynamically -->
                </tbody>
            </table>
        </div>
        
        <!-- User Management Section -->
        <div class="section" id="userManagement" style="display: none;">
            <h2>User Management</h2>
            <table>
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="userManagementBody">
                    <!-- User management data will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Reporting & Analytics Section -->
        <div class="section" id="reporting" style="display: none;">
            <h2>Reporting & Analytics</h2>
            <p>Here you can generate reports based on waste production, collection efficiency, and user engagement.</p>
            <button onclick="generateReport()">Generate Report</button>
            <div id="reportOutput"></div>
        </div>
    </div>

    <script>
        function toggleSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            const mainContent = document.getElementById('mainContent');

            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.style.display = 'block';
                    mainContent.style.display = 'none';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // Fetch vehicles for management
        async function fetchVehicles() {
            const response = await fetch('/api/vehicles');
            const vehicles = await response.json();
            const vehicleManagementBody = document.getElementById('vehicleManagementBody');
            vehicleManagementBody.innerHTML = ''; // Clear existing data

            vehicles.forEach(vehicle => {
                const row = `<tr>
                    <td>${vehicle.vehicle_id}</td>
                    <td>${vehicle.driver_name}</td>
                    <td>${vehicle.driver_phone}</td>
                    <td>${vehicle.area_id}</td>
                    <td>
                        <button onclick="editVehicle(${vehicle.vehicle_id}, '${vehicle.driver_name}', '${vehicle.driver_phone}', ${vehicle.area_id})">Edit</button>
                        <button onclick="deleteVehicle(${vehicle.vehicle_id})">Delete</button>
                    </td>
                </tr>`;
                vehicleManagementBody.innerHTML += row;
            });
        }

        // Handle vehicle form submission
        document.getElementById('vehicleForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                vehicle_id: formData.get('vehicle_id'),
                driver_name: formData.get('driver_name'),
                driver_phone: formData.get('driver_phone'),
                area_id: formData.get('area_id')
            };

            const response = await fetch('/api/manage-vehicle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            const vehicleResponse = document.getElementById('vehicleResponse');
            if (response.ok) {
                vehicleResponse.innerText = 'Vehicle added/updated successfully!';
                fetchVehicles(); // Refresh the vehicle list
                document.getElementById('vehicleForm').reset(); // Reset the form
            } else {
                vehicleResponse.innerText = 'Failed to add/update vehicle. Please try again.';
            }
        };

        // Function to delete a vehicle
        async function deleteVehicle(vehicleId) {
            const response = await fetch(`/api/delete-vehicle/${vehicleId}`, { method: 'DELETE' });
            if (response.ok) {
                alert('Vehicle deleted successfully');
                fetchVehicles(); // Refresh the vehicle list
            } else {
                alert('Failed to delete vehicle');
            }
        }

        // Function to edit a vehicle
        function editVehicle(vehicleId, driverName, driverPhone, areaId) {
            document.getElementById('vehicle_id').value = vehicleId; // Set the vehicle ID for update
            document.getElementById('driver_name').value = driverName; // Set the driver name
            document.getElementById('driver_phone').value = driverPhone; // Set the driver phone
            document.getElementById('area_id').value = areaId; // Set the area ID
        }

        // Toggle vehicle list section
        function toggleVehicleList() {
            const vehicleList = document.getElementById('vehicleList');
            vehicleList.style.display = 'block'; // Show vehicle list
            fetchVehicles(); // Refresh vehicle list
        }

        // Fetch and populate data for complaints, waste tracking, collection management, and user management
        async function fetchData() {
            // Fetch complaints
            const complaintsResponse = await fetch('/api/complaints');
            
            const complaints = await complaintsResponse.json();
            
            const complaintTableBody = document.getElementById('complaintTableBody');
            complaints.forEach(complaint => {
                const row = `<tr>
                    <td>${complaint.complaint_id}</td>
                    <td>${complaint.user_id}</td>
                    <td>${complaint.message}</td>
                    <td><img src="${complaint.image}" alt="Complaint Image" width="100"></td>
                    <td>${complaint.complaint_date}</td>
                    <td>${complaint.complaint_time}</td>
                    <td>${complaint.complaint_status}</td>
                    <td>${complaint.complaint_resolved_date || 'N/A'}</td>
                </tr>`;
                complaintTableBody.innerHTML += row;
            });

            // Fetch waste tracking data
            const wasteResponse = await fetch('/api/waste-tracking');
            const wasteData = await wasteResponse.json();
            document.getElementById('totalBioWaste').innerText = wasteData.bio_weight || 0;
            document.getElementById('totalNonBioWaste').innerText = wasteData.non_bio_weight || 0;
            document.getElementById('totalWasteToday').innerText = wasteData.total_waste_produced_per_day || 0;
 

            // Fetch user-specific waste data
            const userWasteResponse = await fetch('/api/all-area-waste-data');
const userWasteData = await userWasteResponse.json();
const userWasteDataBody = document.getElementById('userWasteDataBody');

// Check if the response contains a message indicating no data
if (userWasteData.message) {
    userWasteDataBody.innerHTML = `<tr><td colspan="2">${userWasteData.message}</td></tr>`;
} else {
    // Handle response as array or wrap object in array
    const userWasteArray = Array.isArray(userWasteData) ? userWasteData : [userWasteData];

    userWasteArray.forEach(user => {
        const row = `<tr>
            <td>${user.area_name}</td>
            <td>${user.total_waste}</td>
        </tr>`;
        userWasteDataBody.innerHTML += row;
    });
}


            // Fetch collection management data
            const collectionResponse = await fetch('/api/collection-management');
const collectionData = await collectionResponse.json();
const collectionManagementBody = document.getElementById('collectionManagementBody');

// Populate the table with the fetched collection data
collectionData.forEach(collection => {
    const row = `<tr>
        <td>${collection.area_name}</td>
        <td>${collection.collection_date} ${collection.collection_time}</td>
        <td>${collection.vehicle_id}</td>
        <td>${collection.driver_name} ${collection.driver_phone}</td>
    </tr>`;
    collectionManagementBody.innerHTML += row;
});


            // Fetch user management data
            const userManagementResponse = await fetch('/api/user-management');
            const userManagementData = await userManagementResponse.json();
            const userManagementBody = document.getElementById('userManagementBody');
            userManagementData.forEach(user => {
                const row = `<tr>
                    <td>${user.user_id}</td>
                    <td>${user.u_name}</td>
                    <td>${user.email}</td>
                    <td><button onclick="deleteUser(${user.user_id})">Delete</button></td>
                </tr>`;
                userManagementBody.innerHTML += row;
            });
        }

        // Function to delete a user
        async function deleteUser(userId) {
            const response = await fetch(`/api/delete-user/${userId}`, { method: 'DELETE' });
            if (response.ok) {
                alert('User deleted successfully');
                location.reload(); // Reload the page to refresh data
            } else {
                alert('Failed to delete user');
            }
        }

        // Function to generate a report
        async function generateReport() {
    const reportOutput = document.getElementById('reportOutput');
    reportOutput.innerHTML = '<p>Generating report...</p>';

    try {
        // Fetch report data from API
        const response = await fetch('/api/report-data');
        const data = await response.json();

        // Format and display report data
        let reportHTML = '<h3>Waste Collection Report</h3>';
        reportHTML += `
            <table border="1" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th>Area</th>
                        <th>Collection Date</th>
                        <th>Collection Time</th>
                        <th>Vehicle</th>
                        <th>Driver</th>
                        <th>Contact</th>
                    </tr>
                </thead>
                <tbody>
        `;
        data.forEach(record => {
            reportHTML += `
                <tr>
                    <td>${record.area_name}</td>
                    <td>${record.c_date}</td>
                    <td>${record.c_time}</td>
                    <td>${record.vehicle_id}</td>
                    <td>${record.driver_name}</td>
                    <td>${record.driver_phone}</td>
                </tr>
            `;
        });
        reportHTML += '</tbody></table>';
        
        reportOutput.innerHTML = reportHTML;

        // Optionally: Add download button
        const downloadButton = document.createElement('button');
        downloadButton.textContent = 'Download Report as PDF';
        downloadButton.onclick = () => downloadReportAsPDF(reportHTML);
        reportOutput.appendChild(downloadButton);

    } catch (error) {
        console.error('Error generating report:', error);
        reportOutput.innerHTML = '<p>Error generating report. Please try again later.</p>';
    }
}

// Example function to download report as PDF
function downloadReportAsPDF(htmlContent) {
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Waste_Collection_Report.pdf';
    link.click();
}


        // Call fetchData on page load
        window.onload = async () => {
            fetchData();
            fetchVehicles();
        };
    </script>
</body>
</html>
